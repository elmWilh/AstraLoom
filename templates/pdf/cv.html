{% set _primary = p.theme_color|default('#38F2AF') %}
{% set _ink = '#0f1115' %}
{% set _muted = '#566072' %}
{% set _line = '#e7eaf1' %}
{% set _chip = '#f3f6fb' %}
{% set _prog = '#8d96a5' %}

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ p.title }} — CV</title>
  <style>
    @page { size: A4; margin: 14mm 14mm; }

    * { box-sizing: border-box; }
    html, body { color: {{ _ink }}; }
    body {
      font: 10.8pt/1.5 "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-print-color-adjust: exact; print-color-adjust: exact; letter-spacing:.1px;
    }
    h1,h2,h3 { margin: 0; }
    h1 { font-size: 22pt; font-weight: 800; line-height: 1.1; }
    h2 {
      margin: 12px 0 8px; font-size: 11pt; font-weight: 800;
      text-transform: uppercase; letter-spacing:.06em; padding-left:10px; position:relative; color:#0b0d11;
      page-break-after: avoid;
    }
    h2:before { content:""; position:absolute; left:0; top:4px; bottom:4px; width:3px; border-radius:3px; background: {{ _primary }}; }
    h3 { font-size: 12pt; font-weight:700; }
    .muted { color: {{ _muted }}; }
    .small { font-size: 9.6pt; }

    .row { display: table; width: 100%; }
    .row > * { display: table-cell; vertical-align: middle; }

    .chip { display:inline-block; font-size:9pt; padding:2px 8px; border-radius:999px; background: {{ _chip }}; border:1px solid {{ _line }}; margin-right:6px; margin-top:4px; }
    .section { margin-top:12px; }
    .card { border:1px solid {{ _line }}; border-radius:10px; padding:10px 12px; background:#fff; page-break-inside:avoid; margin-bottom:8px; }
    .divider { height:2px; background:linear-gradient(90deg, {{ _primary }}, transparent); border-radius:2px; margin:10px 0 12px; }

    .header-table { width:100%; border-collapse:collapse; }
    .header-table td { vertical-align:top; }
    .header-left { padding-right:16px; }
    .header-right { width:190px; text-align:right; }
    .avatar-box{
      display:inline-block; width:148px; height:148px;
      border-radius:16px; overflow:hidden; border:none;
      background-position:center center; background-repeat:no-repeat;
      background-size:contain; background-color:#fff;
    }

    .progress { height:7px; border-radius:7px; background:#eef1f6; overflow:hidden; }
    .progress > span { display:block; height:100%; background: {{ _prog }}; }
    .skill-row { display: table; width: 100%; }
    .skill-name { display: table-cell; vertical-align: middle; }
    .skill-val  { display: table-cell; vertical-align: middle; width: 120px; text-align: right; }

    .bullets { margin:6px 0 0 18px; }
    .bullets li { margin:2px 0; }

    .two-col-table { width:100%; border-collapse:separate; border-spacing:10px 8px; }
    .two-col-table td { width:50%; vertical-align:top; }
    .stack-title { font-weight:700; font-size:10.2pt; margin-bottom:4px; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <table class="header-table">
    <tr>
      <td class="header-left">
        <h1>{{ data.profile.full_name }}</h1>
        <div class="muted">{{ data.profile.role }}{% if data.profile.location %} · {{ data.profile.location }}{% endif %}</div>

        <div style="margin-top:8px">
          {% if data.profile.email %}<span class="chip">✉ {{ data.profile.email }}</span>{% endif %}
          {% if data.profile.phone %}<span class="chip">☎ {{ data.profile.phone }}</span>{% endif %}
          {% if data.profile.contacts.github %}<span class="chip">GitHub: {{ data.profile.contacts.github }}</span>{% endif %}
          {% if data.profile.contacts.linkedin %}<span class="chip">LinkedIn: {{ data.profile.contacts.linkedin }}</span>{% endif %}
          {% if data.profile.contacts.telegram %}<span class="chip">Telegram: {{ data.profile.contacts.telegram }}</span>{% endif %}
        </div>
      </td>
      <td class="header-right">
        <span class="avatar-box" style="background-image:url('{{ url_for('static', filename=data.profile.avatar_url, _external=True) }}')"></span>
      </td>
    </tr>
  </table>

  <div class="divider"></div>

  <!-- SUMMARY -->
  {% set summary_text = data.about_html or data.profile.taglines.get(p.locale) or data.profile.taglines.get('en') %}
  {% if summary_text %}
  <div class="section">
    <h2>Summary</h2>
    <div class="card small">
      {% if data.about_html %}{{ data.about_html|safe }}{% else %}<p class="muted">{{ summary_text }}</p>{% endif %}
    </div>
  </div>
  {% endif %}

  <!-- EXPERIENCE -->
  {% if data.experience and data.experience|length %}
  <div class="section">
    <h2>Experience</h2>
    {% for e in data.experience %}
      <div class="card">
        <div class="row">
          <div><b>{{ e.company }}</b>{% if e.role %} <span class="muted">— {{ e.role }}</span>{% endif %}</div>
          {% if e.period %}<div style="text-align:right"><span class="muted small">{{ e.period }}</span></div>{% endif %}
        </div>
        {% if e.bullets and e.bullets|length %}
          <ul class="bullets small">
            {% for b in e.bullets %}<li>{{ b }}</li>{% endfor %}
          </ul>
        {% endif %}
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- PROJECTS (две колонки) -->
  {% if data.projects and data.projects|length %}
  <div class="section">
    <h2>Projects</h2>
    <table class="two-col-table">
      {% for pair in data.projects[:8]|batch(2, None) %}
      <tr>
        <td>
          {% if pair[0] %}
          <div class="card">
            <div class="row">
              <div><b>{{ pair[0].title }}</b></div>
              {% if pair[0].status %}<div style="text-align:right"><span class="muted small">{{ pair[0].status }}</span></div>{% endif %}
            </div>
            {% if pair[0].description %}<div class="muted small" style="margin-top:6px">{{ pair[0].description }}</div>{% endif %}
            {% if pair[0].tags %}<div style="margin-top:6px">{% for t in pair[0].tags %}<span class="chip">{{ t }}</span>{% endfor %}</div>{% endif %}
            {% if pair[0].github or pair[0].live %}
              <div class="small muted" style="margin-top:6px">
                {% if pair[0].github %}GitHub: {{ pair[0].github }}{% endif %}
                {% if pair[0].live %}{% if pair[0].github %} · {% endif %}Live: {{ pair[0].live }}{% endif %}
              </div>
            {% endif %}
          </div>
          {% endif %}
        </td>
        <td>
          {% if pair[1] %}
          <div class="card">
            <div class="row">
              <div><b>{{ pair[1].title }}</b></div>
              {% if pair[1].status %}<div style="text-align:right"><span class="muted small">{{ pair[1].status }}</span></div>{% endif %}
            </div>
            {% if pair[1].description %}<div class="muted small" style="margin-top:6px">{{ pair[1].description }}</div>{% endif %}
            {% if pair[1].tags %}<div style="margin-top:6px">{% for t in pair[1].tags %}<span class="chip">{{ t }}</span>{% endfor %}</div>{% endif %}
            {% if pair[1].github or pair[1].live %}
              <div class="small muted" style="margin-top:6px">
                {% if pair[1].github %}GitHub: {{ pair[1].github }}{% endif %}
                {% if pair[1].live %}{% if pair[1].github %} · {% endif %}Live: {{ pair[1].live }}{% endif %}
              </div>
            {% endif %}
          </div>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </table>
  </div>
  {% endif %}

  <!-- SKILLS (две колонки) -->
  {% if data.skills and data.skills|length %}
  <div class="section">
    <h2>Skills</h2>
    <table class="two-col-table">
      {% for pair in data.skills|batch(2, None) %}
      <tr>
        <td>
          {% if pair[0] %}
          <div class="card">
            <div class="skill-row small">
              <div class="skill-name"><b>{{ pair[0].name }}</b>{% if pair[0].label %} <span class="muted">· {{ pair[0].label }}</span>{% endif %}</div>
              <div class="skill-val muted">{{ pair[0].level }}%</div>
            </div>
            <div class="progress" style="margin-top:6px"><span style="width: {{ pair[0].level|int }}%">&nbsp;</span></div>
          </div>
          {% endif %}
        </td>
        <td>
          {% if pair[1] %}
          <div class="card">
            <div class="skill-row small">
              <div class="skill-name"><b>{{ pair[1].name }}</b>{% if pair[1].label %} <span class="muted">· {{ pair[1].label }}</span>{% endif %}</div>
              <div class="skill-val muted">{{ pair[1].level }}%</div>
            </div>
            <div class="progress" style="margin-top:6px"><span style="width: {{ pair[1].level|int }}%">&nbsp;</span></div>
          </div>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </table>
  </div>
  {% endif %}

  <!-- LANGUAGES (CEFR, две колонки, как Skills) -->
  {% if data.spoken_languages and data.spoken_languages|length %}
  <div class="section">
    <h2>Languages</h2>
    <table class="two-col-table">
      {% for pair in data.spoken_languages|batch(2, None) %}
      <tr>
        <td>
          {% if pair[0] %}
          <div class="card">
            <div class="row small">
              <div><b>{{ pair[0].name }}</b></div>
              <div style="text-align:right"><span class="muted">{{ pair[0].label }}{% if pair[0].level is not none %} · {{ pair[0].level }}%{% endif %}</span></div>
            </div>
            {% if pair[0].level is not none %}
            <div class="progress" style="margin-top:6px"><span style="width: {{ pair[0].level|int }}%">&nbsp;</span></div>
            {% endif %}
          </div>
          {% endif %}
        </td>
        <td>
          {% if pair[1] %}
          <div class="card">
            <div class="row small">
              <div><b>{{ pair[1].name }}</b></div>
              <div style="text-align:right"><span class="muted">{{ pair[1].label }}{% if pair[1].level is not none %} · {{ pair[1].level }}%{% endif %}</span></div>
            </div>
            {% if pair[1].level is not none %}
            <div class="progress" style="margin-top:6px"><span style="width: {{ pair[1].level|int }}%">&nbsp;</span></div>
            {% endif %}
          </div>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </table>
  </div>
  {% endif %}

  <!-- TECH STACK -->
  {% set sg = data.stack_groups %}
  {% if sg %}
  <div class="section">
    <h2>Tech Stack</h2>
    {% if sg and sg[0] is mapping %}
      {% set ns = namespace(groups=[]) %}
      {% for g in sg if g.visible is not sameas(false) and g['items'] and g['items']|length %}
        {% set _ = ns.groups.append(g) %}
      {% endfor %}
      {% if ns.groups|length %}
        <table class="two-col-table">
          {% for pair in ns.groups|batch(2, None) %}
          <tr>
            <td>
              {% if pair[0] %}
                <div class="card">
                  <div class="stack-title">{{ pair[0].name }}</div>
                  {% for it in pair[0]['items'] %}<span class="chip">{{ it }}</span>{% endfor %}
                </div>
              {% endif %}
            </td>
            <td>
              {% if pair[1] %}
                <div class="card">
                  <div class="stack-title">{{ pair[1].name }}</div>
                  {% for it in pair[1]['items'] %}<span class="chip">{{ it }}</span>{% endfor %}
                </div>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </table>
      {% endif %}
    {% else %}
      {% set ns = namespace(groups=[]) %}
      {% for group, items in sg.items() if items and items|length %}
        {% set _ = ns.groups.append({'name':group, 'items':items}) %}
      {% endfor %}
      {% if ns.groups|length %}
        <table class="two-col-table">
          {% for pair in ns.groups|batch(2, None) %}
          <tr>
            <td>
              {% if pair[0] %}
                <div class="card">
                  <div class="stack-title">{{ pair[0].name }}</div>
                  {% for it in pair[0].items %}<span class="chip">{{ it }}</span>{% endfor %}
                </div>
              {% endif %}
            </td>
            <td>
              {% if pair[1] %}
                <div class="card">
                  <div class="stack-title">{{ pair[1].name }}</div>
                  {% for it in pair[1].items %}<span class="chip">{{ it }}</span>{% endfor %}
                </div>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </table>
      {% endif %}
    {% endif %}
  </div>
  {% endif %}

  <!-- CERTIFICATES -->
  {% if data.certificates and data.certificates|length %}
  <div class="section">
    <h2>Certificates</h2>
    <table class="two-col-table">
      {% for pair in data.certificates|batch(2, None) %}
      <tr>
        <td>
          {% if pair[0] %}
          <div class="card small">
            <div class="row">
              <div><b>{{ pair[0].name }}</b>{% if pair[0].issuer %} <span class="muted">— {{ pair[0].issuer }}</span>{% endif %}</div>
              {% if pair[0].date %}<div style="text-align:right"><span class="muted">{{ pair[0].date }}</span></div>{% endif %}
            </div>
            {% if pair[0].credential_id or pair[0].credential_url %}
              <div class="muted" style="margin-top:4px">
                {% if pair[0].credential_id %}ID: {{ pair[0].credential_id }}{% endif %}
                {% if pair[0].credential_url %}{% if pair[0].credential_id %} · {% endif %}{{ pair[0].credential_url }}{% endif %}
              </div>
            {% endif %}
          </div>
          {% endif %}
        </td>
        <td>
          {% if pair[1] %}
          <div class="card small">
            <div class="row">
              <div><b>{{ pair[1].name }}</b>{% if pair[1].issuer %} <span class="muted">— {{ pair[1].issuer }}</span>{% endif %}</div>
              {% if pair[1].date %}<div style="text-align:right"><span class="muted">{{ pair[1].date }}</span></div>{% endif %}
            </div>
            {% if pair[1].credential_id or pair[1].credential_url %}
              <div class="muted" style="margin-top:4px">
                {% if pair[1].credential_id %}ID: {{ pair[1].credential_id }}{% endif %}
                {% if pair[1].credential_url %}{% if pair[1].credential_id %} · {% endif %}{{ pair[1].credential_url }}{% endif %}
              </div>
            {% endif %}
          </div>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </table>
  </div>
  {% endif %}
  
  <!-- EDUCATION -->
  {% if data.education and data.education|length %}
  <div class="section">
    <h2>Education</h2>
    {% for ed in data.education %}
      {% set is_obj = ed.__class__.__name__ != 'str' %}
      <div class="card">
        <div class="row">
          <div><b>{{ ed.institution if is_obj else ed }}</b>{% if is_obj and ed.field %} <span class="muted">— {{ ed.field }}</span>{% endif %}</div>
          {% if is_obj and (ed.start or ed.end) %}
            <div style="text-align:right"><span class="muted small">
              {% if ed.start %}{{ ed.start }}{% endif %}{% if ed.start or ed.end %} — {% endif %}{{ ed.end if ed.end else 'present' }}
            </span></div>
          {% endif %}
        </div>
        {% if is_obj %}
          <div class="small muted" style="margin-top:4px">
            {% if ed.level %}{{ ed.level }}{% endif %}
            {% if ed.city or ed.country %}{% if ed.level %} · {% endif %}{{ ed.city }}{% if ed.city and ed.country %}, {% endif %}{{ ed.country }}{% endif %}
            {% if ed.mode %}{% if ed.level or ed.city or ed.country %} · {% endif %}{{ ed.mode }}{% endif %}
          </div>
          {% if ed.description %}<div class="small muted" style="margin-top:4px">{{ ed.description }}</div>{% endif %}
        {% endif %}
      </div>
    {% endfor %}
  </div>
  {% endif %}

</body>
</html>
